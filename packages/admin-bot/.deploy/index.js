var Tt=Object.defineProperty;var i=(t,e)=>Tt(t,"name",{value:e,configurable:!0});var en=(t,e)=>{for(var r in e)Tt(t,r,{get:e[r],enumerable:!0})};function h(t){return new Error(`[unenv] ${t} is not implemented yet!`)}i(h,"createNotImplementedError");function U(t){return Object.assign(i(()=>{throw h(t)},"fn"),{__unenv__:!0})}i(U,"notImplemented");function Et(t){return class{__unenv__=!0;constructor(){throw new Error(`[unenv] ${t} is not implemented yet!`)}}}i(Et,"notImplementedClass");var et=globalThis.performance?.timeOrigin??Date.now(),tt=globalThis.performance?.now?globalThis.performance.now.bind(globalThis.performance):()=>Date.now()-et,tn={name:"node",entryType:"node",startTime:0,duration:0,nodeStart:0,v8Start:0,bootstrapComplete:0,environment:0,loopStart:0,loopExit:0,idleTime:0,uvMetricsInfo:{loopCount:0,events:0,eventsWaiting:0},detail:void 0,toJSON(){return this}},B=class{static{i(this,"PerformanceEntry")}__unenv__=!0;detail;entryType="event";name;startTime;constructor(e,r){this.name=e,this.startTime=r?.startTime||tt(),this.detail=r?.detail}get duration(){return tt()-this.startTime}toJSON(){return{name:this.name,entryType:this.entryType,startTime:this.startTime,duration:this.duration,detail:this.detail}}},rt=class extends B{static{i(this,"PerformanceMark")}entryType="mark";constructor(){super(...arguments)}get duration(){return 0}},te=class extends B{static{i(this,"PerformanceMeasure")}entryType="measure"},re=class extends B{static{i(this,"PerformanceResourceTiming")}entryType="resource";serverTiming=[];connectEnd=0;connectStart=0;decodedBodySize=0;domainLookupEnd=0;domainLookupStart=0;encodedBodySize=0;fetchStart=0;initiatorType="";name="";nextHopProtocol="";redirectEnd=0;redirectStart=0;requestStart=0;responseEnd=0;responseStart=0;secureConnectionStart=0;startTime=0;transferSize=0;workerStart=0;responseStatus=0},Ee=class{static{i(this,"PerformanceObserverEntryList")}__unenv__=!0;getEntries(){return[]}getEntriesByName(e,r){return[]}getEntriesByType(e){return[]}},ne=class{static{i(this,"Performance")}__unenv__=!0;timeOrigin=et;eventCounts=new Map;_entries=[];_resourceTimingBufferSize=0;navigation=void 0;timing=void 0;timerify(e,r){throw h("Performance.timerify")}get nodeTiming(){return tn}eventLoopUtilization(){return{}}markResourceTiming(){return new re("")}onresourcetimingbufferfull=null;now(){return this.timeOrigin===et?tt():Date.now()-this.timeOrigin}clearMarks(e){this._entries=e?this._entries.filter(r=>r.name!==e):this._entries.filter(r=>r.entryType!=="mark")}clearMeasures(e){this._entries=e?this._entries.filter(r=>r.name!==e):this._entries.filter(r=>r.entryType!=="measure")}clearResourceTimings(){this._entries=this._entries.filter(e=>e.entryType!=="resource"||e.entryType!=="navigation")}getEntries(){return this._entries}getEntriesByName(e,r){return this._entries.filter(n=>n.name===e&&(!r||n.entryType===r))}getEntriesByType(e){return this._entries.filter(r=>r.entryType===e)}mark(e,r){let n=new rt(e,r);return this._entries.push(n),n}measure(e,r,n){let o,a;typeof r=="string"?(o=this.getEntriesByName(r,"mark")[0]?.startTime,a=this.getEntriesByName(n,"mark")[0]?.startTime):(o=Number.parseFloat(r?.start)||this.now(),a=Number.parseFloat(r?.end)||this.now());let s=new te(e,{startTime:o,detail:{start:o,end:a}});return this._entries.push(s),s}setResourceTimingBufferSize(e){this._resourceTimingBufferSize=e}addEventListener(e,r,n){throw h("Performance.addEventListener")}removeEventListener(e,r,n){throw h("Performance.removeEventListener")}dispatchEvent(e){throw h("Performance.dispatchEvent")}toJSON(){return this}},Pe=class{static{i(this,"PerformanceObserver")}__unenv__=!0;static supportedEntryTypes=[];_callback=null;constructor(e){this._callback=e}takeRecords(){return[]}disconnect(){throw h("PerformanceObserver.disconnect")}observe(e){throw h("PerformanceObserver.observe")}bind(e){return e}runInAsyncScope(e,r,...n){return e.call(r,...n)}asyncId(){return 0}triggerAsyncId(){return 0}emitDestroy(){return this}},Pt=globalThis.performance&&"addEventListener"in globalThis.performance?globalThis.performance:new ne;globalThis.performance=Pt;globalThis.Performance=ne;globalThis.PerformanceEntry=B;globalThis.PerformanceMark=rt;globalThis.PerformanceMeasure=te;globalThis.PerformanceObserver=Pe;globalThis.PerformanceObserverEntryList=Ee;globalThis.PerformanceResourceTiming=re;import{Writable as Ot}from"node:stream";var I=Object.assign(()=>{},{__unenv__:!0});var _=globalThis.console,Ut=!0,Rt=new Ot,jt=new Ot,Oe=_?.log??I,rn=_?.info??Oe,Da=_?.trace??rn,Aa=_?.debug??Oe,Za=_?.table??Oe,nn=_?.error??Oe,Ma=_?.warn??nn,La=_?.createTask??U("console.createTask");var Ca=_?.clear??I,Ba=_?.count??I,Wa=_?.countReset??I,Fa=_?.dir??I,Ga=_?.dirxml??I,Va=_?.group??I,Ja=_?.groupEnd??I,Ka=_?.groupCollapsed??I,Ha=_?.profile??I,Xa=_?.profileEnd??I,Qa=_?.time??I,qa=_?.timeEnd??I,Ya=_?.timeLog??I,es=_?.timeStamp??I,Dt=_?.Console??Et("console.Console"),At=new Map;var Zt=I,Mt=I;var nt=globalThis.console,{assert:ss,clear:us,context:cs,count:ls,countReset:ds,createTask:ms,debug:ps,dir:fs,dirxml:gs,error:vs,group:hs,groupCollapsed:ys,groupEnd:$s,info:_s,log:bs,profile:xs,profileEnd:ws,table:Is,time:ks,timeEnd:zs,timeLog:Ns,timeStamp:Ss,trace:Ts,warn:Es}=nt;Object.assign(nt,{Console:Dt,_ignoreErrors:Ut,_stderr:Rt,_stderrErrorHandler:Mt,_stdout:jt,_stdoutErrorHandler:Zt,_times:At});var Lt=nt;globalThis.console=Lt;var Ct=Object.assign(i(function(e){let r=Date.now(),n=Math.trunc(r/1e3),o=r%1e3*1e6;if(e){let a=n-e[0],s=o-e[0];return s<0&&(a=a-1,s=1e9+s),[a,s]}return[n,o]},"hrtime"),{bigint:i(function(){return BigInt(Date.now()*1e6)},"bigint")});import{EventEmitter as Bt}from"node:events";var K=class{static{i(this,"WriteStream")}fd;columns=80;rows=24;isTTY=!1;constructor(e){this.fd=e}clearLine(e,r){return r&&r(),!1}clearScreenDown(e){return e&&e(),!1}cursorTo(e,r,n){return n&&typeof n=="function"&&n(),!1}moveCursor(e,r,n){return n&&n(),!1}getColorDepth(e){return 1}hasColors(e,r){return!1}getWindowSize(){return[this.columns,this.rows]}write(e,r,n){e instanceof Uint8Array&&(e=new TextDecoder().decode(e));try{console.log(e)}catch{}return n&&typeof n=="function"&&n(),!1}};var ie=class{static{i(this,"ReadStream")}fd;isRaw=!1;isTTY=!1;constructor(e){this.fd=e}setRawMode(e){return this.isRaw=e,this}};var it="22.14.0";var Ue=class t extends Bt{static{i(this,"Process")}env;hrtime;nextTick;constructor(e){super(),this.env=e.env,this.hrtime=e.hrtime,this.nextTick=e.nextTick;for(let r of[...Object.getOwnPropertyNames(t.prototype),...Object.getOwnPropertyNames(Bt.prototype)]){let n=this[r];typeof n=="function"&&(this[r]=n.bind(this))}}emitWarning(e,r,n){console.warn(`${n?`[${n}] `:""}${r?`${r}: `:""}${e}`)}emit(...e){return super.emit(...e)}listeners(e){return super.listeners(e)}#t;#r;#n;get stdin(){return this.#t??=new ie(0)}get stdout(){return this.#r??=new K(1)}get stderr(){return this.#n??=new K(2)}#e="/";chdir(e){this.#e=e}cwd(){return this.#e}arch="";platform="";argv=[];argv0="";execArgv=[];execPath="";title="";pid=200;ppid=100;get version(){return`v${it}`}get versions(){return{node:it}}get allowedNodeEnvironmentFlags(){return new Set}get sourceMapsEnabled(){return!1}get debugPort(){return 0}get throwDeprecation(){return!1}get traceDeprecation(){return!1}get features(){return{}}get release(){return{}}get connected(){return!1}get config(){return{}}get moduleLoadList(){return[]}constrainedMemory(){return 0}availableMemory(){return 0}uptime(){return 0}resourceUsage(){return{}}ref(){}unref(){}umask(){throw h("process.umask")}getBuiltinModule(){}getActiveResourcesInfo(){throw h("process.getActiveResourcesInfo")}exit(){throw h("process.exit")}reallyExit(){throw h("process.reallyExit")}kill(){throw h("process.kill")}abort(){throw h("process.abort")}dlopen(){throw h("process.dlopen")}setSourceMapsEnabled(){throw h("process.setSourceMapsEnabled")}loadEnvFile(){throw h("process.loadEnvFile")}disconnect(){throw h("process.disconnect")}cpuUsage(){throw h("process.cpuUsage")}setUncaughtExceptionCaptureCallback(){throw h("process.setUncaughtExceptionCaptureCallback")}hasUncaughtExceptionCaptureCallback(){throw h("process.hasUncaughtExceptionCaptureCallback")}initgroups(){throw h("process.initgroups")}openStdin(){throw h("process.openStdin")}assert(){throw h("process.assert")}binding(){throw h("process.binding")}permission={has:U("process.permission.has")};report={directory:"",filename:"",signal:"SIGUSR2",compact:!1,reportOnFatalError:!1,reportOnSignal:!1,reportOnUncaughtException:!1,getReport:U("process.report.getReport"),writeReport:U("process.report.writeReport")};finalization={register:U("process.finalization.register"),unregister:U("process.finalization.unregister"),registerBeforeExit:U("process.finalization.registerBeforeExit")};memoryUsage=Object.assign(()=>({arrayBuffers:0,rss:0,external:0,heapTotal:0,heapUsed:0}),{rss:i(()=>0,"rss")});mainModule=void 0;domain=void 0;send=void 0;exitCode=void 0;channel=void 0;getegid=void 0;geteuid=void 0;getgid=void 0;getgroups=void 0;getuid=void 0;setegid=void 0;seteuid=void 0;setgid=void 0;setgroups=void 0;setuid=void 0;_events=void 0;_eventsCount=void 0;_exiting=void 0;_maxListeners=void 0;_debugEnd=void 0;_debugProcess=void 0;_fatalException=void 0;_getActiveHandles=void 0;_getActiveRequests=void 0;_kill=void 0;_preload_modules=void 0;_rawDebug=void 0;_startProfilerIdleNotifier=void 0;_stopProfilerIdleNotifier=void 0;_tickCallback=void 0;_disconnect=void 0;_handleQueue=void 0;_pendingMessage=void 0;_channel=void 0;_send=void 0;_linkedBinding=void 0};var Wt=globalThis.process,Ft=Wt.getBuiltinModule,{exit:on,platform:an,nextTick:Gt}=Ft("node:process"),sn=new Ue({env:Wt.env,hrtime:Ct,nextTick:Gt}),{abort:un,addListener:cn,allowedNodeEnvironmentFlags:ln,hasUncaughtExceptionCaptureCallback:dn,setUncaughtExceptionCaptureCallback:mn,loadEnvFile:pn,sourceMapsEnabled:fn,arch:gn,argv:vn,argv0:hn,chdir:yn,config:$n,connected:_n,constrainedMemory:bn,availableMemory:xn,cpuUsage:wn,cwd:In,debugPort:kn,dlopen:zn,disconnect:Nn,emit:Sn,emitWarning:Tn,env:En,eventNames:Pn,execArgv:On,execPath:Un,finalization:Rn,features:jn,getActiveResourcesInfo:Dn,getMaxListeners:An,hrtime:Zn,kill:Mn,listeners:Ln,listenerCount:Cn,memoryUsage:Bn,on:Wn,off:Fn,once:Gn,pid:Vn,ppid:Jn,prependListener:Kn,prependOnceListener:Hn,rawListeners:Xn,release:Qn,removeAllListeners:qn,removeListener:Yn,report:ei,resourceUsage:ti,setMaxListeners:ri,setSourceMapsEnabled:ni,stderr:ii,stdin:oi,stdout:ai,title:si,throwDeprecation:ui,traceDeprecation:ci,umask:li,uptime:di,version:mi,versions:pi,domain:fi,initgroups:gi,moduleLoadList:vi,reallyExit:hi,openStdin:yi,assert:$i,binding:_i,send:bi,exitCode:xi,channel:wi,getegid:Ii,geteuid:ki,getgid:zi,getgroups:Ni,getuid:Si,setegid:Ti,seteuid:Ei,setgid:Pi,setgroups:Oi,setuid:Ui,permission:Ri,mainModule:ji,_events:Di,_eventsCount:Ai,_exiting:Zi,_maxListeners:Mi,_debugEnd:Li,_debugProcess:Ci,_fatalException:Bi,_getActiveHandles:Wi,_getActiveRequests:Fi,_kill:Gi,_preload_modules:Vi,_rawDebug:Ji,_startProfilerIdleNotifier:Ki,_stopProfilerIdleNotifier:Hi,_tickCallback:Xi,_disconnect:Qi,_handleQueue:qi,_pendingMessage:Yi,_channel:eo,_send:to,_linkedBinding:ro}=sn,no={abort:un,addListener:cn,allowedNodeEnvironmentFlags:ln,hasUncaughtExceptionCaptureCallback:dn,setUncaughtExceptionCaptureCallback:mn,loadEnvFile:pn,sourceMapsEnabled:fn,arch:gn,argv:vn,argv0:hn,chdir:yn,config:$n,connected:_n,constrainedMemory:bn,availableMemory:xn,cpuUsage:wn,cwd:In,debugPort:kn,dlopen:zn,disconnect:Nn,emit:Sn,emitWarning:Tn,env:En,eventNames:Pn,execArgv:On,execPath:Un,exit:on,finalization:Rn,features:jn,getBuiltinModule:Ft,getActiveResourcesInfo:Dn,getMaxListeners:An,hrtime:Zn,kill:Mn,listeners:Ln,listenerCount:Cn,memoryUsage:Bn,nextTick:Gt,on:Wn,off:Fn,once:Gn,pid:Vn,platform:an,ppid:Jn,prependListener:Kn,prependOnceListener:Hn,rawListeners:Xn,release:Qn,removeAllListeners:qn,removeListener:Yn,report:ei,resourceUsage:ti,setMaxListeners:ri,setSourceMapsEnabled:ni,stderr:ii,stdin:oi,stdout:ai,title:si,throwDeprecation:ui,traceDeprecation:ci,umask:li,uptime:di,version:mi,versions:pi,domain:fi,initgroups:gi,moduleLoadList:vi,reallyExit:hi,openStdin:yi,assert:$i,binding:_i,send:bi,exitCode:xi,channel:wi,getegid:Ii,geteuid:ki,getgid:zi,getgroups:Ni,getuid:Si,setegid:Ti,seteuid:Ei,setgid:Pi,setgroups:Oi,setuid:Ui,permission:Ri,mainModule:ji,_events:Di,_eventsCount:Ai,_exiting:Zi,_maxListeners:Mi,_debugEnd:Li,_debugProcess:Ci,_fatalException:Bi,_getActiveHandles:Wi,_getActiveRequests:Fi,_kill:Gi,_preload_modules:Vi,_rawDebug:Ji,_startProfilerIdleNotifier:Ki,_stopProfilerIdleNotifier:Hi,_tickCallback:Xi,_disconnect:Qi,_handleQueue:qi,_pendingMessage:Yi,_channel:eo,_send:to,_linkedBinding:ro},Vt=no;globalThis.process=Vt;function w(t,e,r){function n(u,c){var p;Object.defineProperty(u,"_zod",{value:u._zod??{},enumerable:!1}),(p=u._zod).traits??(p.traits=new Set),u._zod.traits.add(t),e(u,c);for(let y in s.prototype)y in u||Object.defineProperty(u,y,{value:s.prototype[y].bind(u)});u._zod.constr=s,u._zod.def=c}i(n,"init");let o=r?.Parent??Object;class a extends o{static{i(this,"Definition")}}Object.defineProperty(a,"name",{value:t});function s(u){var c;let p=r?.Parent?new a:this;n(p,u),(c=p._zod).deferred??(c.deferred=[]);for(let y of p._zod.deferred)y();return p}return i(s,"_"),Object.defineProperty(s,"init",{value:n}),Object.defineProperty(s,Symbol.hasInstance,{value:i(u=>r?.Parent&&u instanceof r.Parent?!0:u?._zod?.traits?.has(t),"value")}),Object.defineProperty(s,"name",{value:t}),s}i(w,"$constructor");var io=Symbol("zod_brand"),A=class extends Error{static{i(this,"$ZodAsyncError")}constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},Re={};function W(t){return t&&Object.assign(Re,t),Re}i(W,"config");var l={};en(l,{BIGINT_FORMAT_RANGES:()=>Yt,Class:()=>at,NUMBER_FORMAT_RANGES:()=>qt,aborted:()=>se,allowsEval:()=>lt,assert:()=>co,assertEqual:()=>oo,assertIs:()=>so,assertNever:()=>uo,assertNotEqual:()=>ao,assignProp:()=>ct,cached:()=>je,cleanEnum:()=>xo,cleanRegex:()=>De,clone:()=>T,createTransparentProxy:()=>go,defineLazy:()=>R,esc:()=>F,escapeRegex:()=>dt,extend:()=>yo,finalizeIssue:()=>G,floatSafeRemainder:()=>Kt,getElementAtPath:()=>lo,getEnumValues:()=>st,getLengthableOrigin:()=>tr,getParsedType:()=>fo,getSizableOrigin:()=>er,isObject:()=>ae,isPlainObject:()=>Ht,issue:()=>rr,joinValues:()=>m,jsonStringifyReplacer:()=>ut,merge:()=>$o,normalizeParams:()=>Ze,nullish:()=>Jt,numKeys:()=>po,omit:()=>ho,optionalKeys:()=>mt,partial:()=>_o,pick:()=>vo,prefixIssues:()=>ue,primitiveTypes:()=>Qt,promiseAllObject:()=>mo,propertyKeyTypes:()=>Xt,randomString:()=>Ae,required:()=>bo,stringifyPrimitive:()=>d,unwrapMessage:()=>oe});function oo(t){return t}i(oo,"assertEqual");function ao(t){return t}i(ao,"assertNotEqual");function so(t){}i(so,"assertIs");function uo(t){throw new Error}i(uo,"assertNever");function co(t){}i(co,"assert");function st(t){let e=Object.values(t).filter(n=>typeof n=="number");return Object.entries(t).filter(([n,o])=>e.indexOf(+n)===-1).map(([n,o])=>o)}i(st,"getEnumValues");function m(t,e="|"){return t.map(r=>d(r)).join(e)}i(m,"joinValues");function ut(t,e){return typeof e=="bigint"?e.toString():e}i(ut,"jsonStringifyReplacer");function je(t){return{get value(){{let r=t();return Object.defineProperty(this,"value",{value:r}),r}throw new Error("cached value already set")}}}i(je,"cached");function Jt(t){return t==null}i(Jt,"nullish");function De(t){let e=t.startsWith("^")?1:0,r=t.endsWith("$")?t.length-1:t.length;return t.slice(e,r)}i(De,"cleanRegex");function Kt(t,e){let r=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,o=r>n?r:n,a=Number.parseInt(t.toFixed(o).replace(".","")),s=Number.parseInt(e.toFixed(o).replace(".",""));return a%s/10**o}i(Kt,"floatSafeRemainder");function R(t,e,r){Object.defineProperty(t,e,{get(){{let o=r();return t[e]=o,o}throw new Error("cached value already set")},set(o){Object.defineProperty(t,e,{value:o})},configurable:!0})}i(R,"defineLazy");function ct(t,e,r){Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!0,configurable:!0})}i(ct,"assignProp");function lo(t,e){return e?e.reduce((r,n)=>r?.[n],t):t}i(lo,"getElementAtPath");function mo(t){let e=Object.keys(t),r=e.map(n=>t[n]);return Promise.all(r).then(n=>{let o={};for(let a=0;a<e.length;a++)o[e[a]]=n[a];return o})}i(mo,"promiseAllObject");function Ae(t=10){let e="abcdefghijklmnopqrstuvwxyz",r="";for(let n=0;n<t;n++)r+=e[Math.floor(Math.random()*e.length)];return r}i(Ae,"randomString");function F(t){return JSON.stringify(t)}i(F,"esc");function ae(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}i(ae,"isObject");var lt=je(()=>{try{let t=Function;return new t(""),!0}catch{return!1}});function Ht(t){if(ae(t)===!1)return!1;let e=t.constructor;if(e===void 0)return!0;let r=e.prototype;return!(ae(r)===!1||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)}i(Ht,"isPlainObject");function po(t){let e=0;for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&e++;return e}i(po,"numKeys");var fo=i(t=>{let e=typeof t;switch(e){case"undefined":return"undefined";case"string":return"string";case"number":return Number.isNaN(t)?"nan":"number";case"boolean":return"boolean";case"function":return"function";case"bigint":return"bigint";case"symbol":return"symbol";case"object":return Array.isArray(t)?"array":t===null?"null":t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?"promise":typeof Map<"u"&&t instanceof Map?"map":typeof Set<"u"&&t instanceof Set?"set":typeof Date<"u"&&t instanceof Date?"date":typeof File<"u"&&t instanceof File?"file":"object";default:throw new Error(`Unknown data type: ${e}`)}},"getParsedType"),Xt=new Set(["string","number","symbol"]),Qt=new Set(["string","number","bigint","boolean","symbol","undefined"]);function dt(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}i(dt,"escapeRegex");function T(t,e,r){let n=new t._zod.constr(e??t._zod.def);return(!e||r?.parent)&&(n._zod.parent=t),n}i(T,"clone");function Ze(t){let e=t;if(!e)return{};if(typeof e=="string")return{error:i(()=>e,"error")};if(e?.message!==void 0){if(e?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:i(()=>e.error,"error")}:e}i(Ze,"normalizeParams");function go(t){let e;return new Proxy({},{get(r,n,o){return e??(e=t()),Reflect.get(e,n,o)},set(r,n,o,a){return e??(e=t()),Reflect.set(e,n,o,a)},has(r,n){return e??(e=t()),Reflect.has(e,n)},deleteProperty(r,n){return e??(e=t()),Reflect.deleteProperty(e,n)},ownKeys(r){return e??(e=t()),Reflect.ownKeys(e)},getOwnPropertyDescriptor(r,n){return e??(e=t()),Reflect.getOwnPropertyDescriptor(e,n)},defineProperty(r,n,o){return e??(e=t()),Reflect.defineProperty(e,n,o)}})}i(go,"createTransparentProxy");function d(t){return typeof t=="bigint"?t.toString()+"n":typeof t=="string"?`"${t}"`:`${t}`}i(d,"stringifyPrimitive");function mt(t){return Object.keys(t).filter(e=>t[e]._zod.optin==="optional"&&t[e]._zod.optout==="optional")}i(mt,"optionalKeys");var qt={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]},Yt={int64:[BigInt("-9223372036854775808"),BigInt("9223372036854775807")],uint64:[BigInt(0),BigInt("18446744073709551615")]};function vo(t,e){let r={},n=t._zod.def;for(let o in e){if(!(o in n.shape))throw new Error(`Unrecognized key: "${o}"`);e[o]&&(r[o]=n.shape[o])}return T(t,{...t._zod.def,shape:r,checks:[]})}i(vo,"pick");function ho(t,e){let r={...t._zod.def.shape},n=t._zod.def;for(let o in e){if(!(o in n.shape))throw new Error(`Unrecognized key: "${o}"`);e[o]&&delete r[o]}return T(t,{...t._zod.def,shape:r,checks:[]})}i(ho,"omit");function yo(t,e){let r={...t._zod.def,get shape(){let n={...t._zod.def.shape,...e};return ct(this,"shape",n),n},checks:[]};return T(t,r)}i(yo,"extend");function $o(t,e){return T(t,{...t._zod.def,get shape(){let r={...t._zod.def.shape,...e._zod.def.shape};return ct(this,"shape",r),r},catchall:e._zod.def.catchall,checks:[]})}i($o,"merge");function _o(t,e,r){let n=e._zod.def.shape,o={...n};if(r)for(let a in r){if(!(a in n))throw new Error(`Unrecognized key: "${a}"`);r[a]&&(o[a]=t?new t({type:"optional",innerType:n[a]}):n[a])}else for(let a in n)o[a]=t?new t({type:"optional",innerType:n[a]}):n[a];return T(e,{...e._zod.def,shape:o,checks:[]})}i(_o,"partial");function bo(t,e,r){let n=e._zod.def.shape,o={...n};if(r)for(let a in r){if(!(a in o))throw new Error(`Unrecognized key: "${a}"`);r[a]&&(o[a]=new t({type:"nonoptional",innerType:n[a]}))}else for(let a in n)o[a]=new t({type:"nonoptional",innerType:n[a]});return T(e,{...e._zod.def,shape:o,checks:[]})}i(bo,"required");function se(t,e=0){for(let r=e;r<t.issues.length;r++)if(t.issues[r].continue!==!0)return!0;return!1}i(se,"aborted");function ue(t,e){return e.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(t),r})}i(ue,"prefixIssues");function oe(t){return typeof t=="string"?t:t?.message}i(oe,"unwrapMessage");function G(t,e,r){let n={...t,path:t.path??[]};if(!t.message){let o=oe(t.inst?._zod.def?.error?.(t))??oe(e?.error?.(t))??oe(r.customError?.(t))??oe(r.localeError?.(t))??"Invalid input";n.message=o}return delete n.inst,delete n.continue,e?.reportInput||delete n.input,n}i(G,"finalizeIssue");function er(t){return t instanceof Set?"set":t instanceof Map?"map":t instanceof File?"file":"unknown"}i(er,"getSizableOrigin");function tr(t){return Array.isArray(t)?"array":typeof t=="string"?"string":"unknown"}i(tr,"getLengthableOrigin");function rr(...t){let[e,r,n]=t;return typeof e=="string"?{message:e,code:"custom",input:r,inst:n}:{...e}}i(rr,"issue");function xo(t){return Object.entries(t).filter(([e,r])=>Number.isNaN(Number.parseInt(e,10))).map(e=>e[1])}i(xo,"cleanEnum");var at=class{static{i(this,"Class")}constructor(...e){}};var nr=i((t,e)=>{t.name="$ZodError",Object.defineProperty(t,"_zod",{value:t._zod,enumerable:!1}),Object.defineProperty(t,"issues",{value:e,enumerable:!1}),Object.defineProperty(t,"message",{get(){return JSON.stringify(e,ut,2)},enumerable:!0})},"initializer"),ir=w("$ZodError",nr),ce=w("$ZodError",nr,{Parent:Error});var Io=i(t=>(e,r,n,o)=>{let a=n?Object.assign(n,{async:!1}):{async:!1},s=e._zod.run({value:r,issues:[]},a);if(s instanceof Promise)throw new A;if(s.issues.length){let u=new(o?.Err??t)(s.issues.map(c=>G(c,a,W())));throw Error.captureStackTrace(u,o?.callee),u}return s.value},"_parse"),Me=Io(ce),ko=i(t=>async(e,r,n,o)=>{let a=n?Object.assign(n,{async:!0}):{async:!0},s=e._zod.run({value:r,issues:[]},a);if(s instanceof Promise&&(s=await s),s.issues.length){let u=new(o?.Err??t)(s.issues.map(c=>G(c,a,W())));throw Error.captureStackTrace(u,o?.callee),u}return s.value},"_parseAsync"),Le=ko(ce),zo=i(t=>(e,r,n)=>{let o=n?{...n,async:!1}:{async:!1},a=e._zod.run({value:r,issues:[]},o);if(a instanceof Promise)throw new A;return a.issues.length?{success:!1,error:new(t??ir)(a.issues.map(s=>G(s,o,W())))}:{success:!0,data:a.value}},"_safeParse"),le=zo(ce),No=i(t=>async(e,r,n)=>{let o=n?Object.assign(n,{async:!0}):{async:!0},a=e._zod.run({value:r,issues:[]},o);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new t(a.issues.map(s=>G(s,o,W())))}:{success:!0,data:a.value}},"_safeParseAsync"),de=No(ce);var So="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",To=new RegExp(`^${So}$`);var or=i(t=>{let e=t?`[\\s\\S]{${t?.minimum??0},${t?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${e}$`)},"string");var ar=/^-?\d+(?:\.\d+)?/i;var Be=class{static{i(this,"Doc")}constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if(typeof e=="function"){e(this,{execution:"sync"}),e(this,{execution:"async"});return}let n=e.split(`
`).filter(s=>s),o=Math.min(...n.map(s=>s.length-s.trimStart().length)),a=n.map(s=>s.slice(o)).map(s=>" ".repeat(this.indent*2)+s);for(let s of a)this.content.push(s)}compile(){let e=Function,r=this?.args,o=[...(this?.content??[""]).map(a=>`  ${a}`)];return new e(...r,o.join(`
`))}};var ur={major:4,minor:0,patch:0};var j=w("$ZodType",(t,e)=>{var r;t??(t={}),t._zod.id=e.type+"_"+Ae(10),t._zod.def=e,t._zod.bag=t._zod.bag||{},t._zod.version=ur;let n=[...t._zod.def.checks??[]];t._zod.traits.has("$ZodCheck")&&n.unshift(t);for(let o of n)for(let a of o._zod.onattach)a(t);if(n.length===0)(r=t._zod).deferred??(r.deferred=[]),t._zod.deferred?.push(()=>{t._zod.run=t._zod.parse});else{let o=i((a,s,u)=>{let c=se(a),p;for(let y of s){if(y._zod.when){if(!y._zod.when(a))continue}else if(c)continue;let f=a.issues.length,v=y._zod.check(a);if(v instanceof Promise&&u?.async===!1)throw new A;if(p||v instanceof Promise)p=(p??Promise.resolve()).then(async()=>{await v,a.issues.length!==f&&(c||(c=se(a,f)))});else{if(a.issues.length===f)continue;c||(c=se(a,f))}}return p?p.then(()=>a):a},"runChecks");t._zod.run=(a,s)=>{let u=t._zod.parse(a,s);if(u instanceof Promise){if(s.async===!1)throw new A;return u.then(c=>o(c,n,s))}return o(u,n,s)}}t["~standard"]={validate:i(o=>{try{let a=le(t,o);return a.success?{value:a.data}:{issues:a.error?.issues}}catch{return de(t,o).then(s=>s.success?{value:s.data}:{issues:s.error?.issues})}},"validate"),vendor:"zod",version:1}}),pt=w("$ZodString",(t,e)=>{j.init(t,e),t._zod.pattern=[...t?._zod.bag?.patterns??[]].pop()??or(t._zod.bag),t._zod.parse=(r,n)=>{if(e.coerce)try{r.value=String(r.value)}catch{}return typeof r.value=="string"||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:t}),r}});var lr=w("$ZodNumber",(t,e)=>{j.init(t,e),t._zod.pattern=t._zod.bag.pattern??ar,t._zod.parse=(r,n)=>{if(e.coerce)try{r.value=Number(r.value)}catch{}let o=r.value;if(typeof o=="number"&&!Number.isNaN(o)&&Number.isFinite(o))return r;let a=typeof o=="number"?Number.isNaN(o)?"NaN":Number.isFinite(o)?void 0:"Infinity":void 0;return r.issues.push({expected:"number",code:"invalid_type",input:o,inst:t,...a?{received:a}:{}}),r}});function We(t,e,r){t.issues.length&&e.issues.push(...ue(r,t.issues)),e.value[r]=t.value}i(We,"handleObjectResult");function cr(t,e,r,n){t.issues.length?n[r]===void 0?r in n?e.value[r]=void 0:e.value[r]=t.value:e.issues.push(...ue(r,t.issues)):t.value===void 0?r in n&&(e.value[r]=void 0):e.value[r]=t.value}i(cr,"handleOptionalObjectResult");var dr=w("$ZodObject",(t,e)=>{j.init(t,e);let r=je(()=>{let f=Object.keys(e.shape);for(let b of f)if(!(e.shape[b]instanceof j))throw new Error(`Invalid element at key "${b}": expected a Zod schema`);let v=mt(e.shape);return{shape:e.shape,keys:f,keySet:new Set(f),numKeys:f.length,optionalKeys:new Set(v)}});R(t._zod,"propValues",()=>{let f=e.shape,v={};for(let b in f){let S=f[b]._zod;if(S.values){v[b]??(v[b]=new Set);for(let D of S.values)v[b].add(D)}}return v});let n=i(f=>{let v=new Be(["shape","payload","ctx"]),{keys:b,optionalKeys:S}=r.value,D=i(k=>{let $=F(k);return`shape[${$}]._zod.run({ value: input[${$}], issues: [] }, ctx)`},"parseStr");v.write("const input = payload.value;");let Y=Object.create(null);for(let k of b)Y[k]=Ae(15);v.write("const newResult = {}");for(let k of b)if(S.has(k)){let $=Y[k];v.write(`const ${$} = ${D(k)};`);let x=F(k);v.write(`
        if (${$}.issues.length) {
          if (input[${x}] === undefined) {
            if (${x} in input) {
              newResult[${x}] = undefined;
            }
          } else {
            payload.issues = payload.issues.concat(
              ${$}.issues.map((iss) => ({
                ...iss,
                path: iss.path ? [${x}, ...iss.path] : [${x}],
              }))
            );
          }
        } else if (${$}.value === undefined) {
          if (${x} in input) newResult[${x}] = undefined;
        } else {
          newResult[${x}] = ${$}.value;
        }
        `)}else{let $=Y[k];v.write(`const ${$} = ${D(k)};`),v.write(`
          if (${$}.issues.length) payload.issues = payload.issues.concat(${$}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${F(k)}, ...iss.path] : [${F(k)}]
          })));`),v.write(`newResult[${F(k)}] = ${$}.value`)}v.write("payload.value = newResult;"),v.write("return payload;");let Se=v.compile();return(k,$)=>Se(f,k,$)},"generateFastpass"),o,a=ae,s=!Re.jitless,c=s&&lt.value,{catchall:p}=e,y;t._zod.parse=(f,v)=>{y??(y=r.value);let b=f.value;if(!a(b))return f.issues.push({expected:"object",code:"invalid_type",input:b,inst:t}),f;let S=[];if(s&&c&&v?.async===!1&&v.jitless!==!0)o||(o=n(e.shape)),f=o(f,v);else{f.value={};let $=y.shape;for(let x of y.keys){let ee=$[x],Te=ee._zod.run({value:b[x],issues:[]},v),Nt=ee._zod.optin==="optional"&&ee._zod.optout==="optional";Te instanceof Promise?S.push(Te.then(St=>Nt?cr(St,f,x,b):We(St,f,x))):Nt?cr(Te,f,x,b):We(Te,f,x)}}if(!p)return S.length?Promise.all(S).then(()=>f):f;let D=[],Y=y.keySet,Se=p._zod,k=Se.def.type;for(let $ of Object.keys(b)){if(Y.has($))continue;if(k==="never"){D.push($);continue}let x=Se.run({value:b[$],issues:[]},v);x instanceof Promise?S.push(x.then(ee=>We(ee,f,$))):We(x,f,$)}return D.length&&f.issues.push({code:"unrecognized_keys",keys:D,input:b,inst:t}),S.length?Promise.all(S).then(()=>f):f}});var mr=w("$ZodOptional",(t,e)=>{j.init(t,e),t._zod.optin="optional",t._zod.optout="optional",R(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),R(t._zod,"pattern",()=>{let r=e.innerType._zod.pattern;return r?new RegExp(`^(${De(r.source)})?$`):void 0}),t._zod.parse=(r,n)=>r.value===void 0?r:e.innerType._zod.run(r,n)}),pr=w("$ZodNullable",(t,e)=>{j.init(t,e),R(t._zod,"optin",()=>e.innerType._zod.optin),R(t._zod,"optout",()=>e.innerType._zod.optout),R(t._zod,"pattern",()=>{let r=e.innerType._zod.pattern;return r?new RegExp(`^(${De(r.source)}|null)$`):void 0}),R(t._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),t._zod.parse=(r,n)=>r.value===null?r:e.innerType._zod.run(r,n)});var Po=Symbol("ZodOutput"),Oo=Symbol("ZodInput");function vr(t,e){return new t({type:"string",...Ze(e)})}i(vr,"_string");function hr(t,e){return new t({type:"number",checks:[],...Ze(e)})}i(hr,"_number");var me=w("ZodMiniType",(t,e)=>{if(!t._zod)throw new Error("Uninitialized schema in ZodMiniType.");j.init(t,e),t.def=e,t.parse=(r,n)=>Me(t,r,n,{callee:t.parse}),t.safeParse=(r,n)=>le(t,r,n),t.parseAsync=async(r,n)=>Le(t,r,n,{callee:t.parseAsync}),t.safeParseAsync=async(r,n)=>de(t,r,n),t.check=(...r)=>t.clone({...e,checks:[...e.checks??[],...r.map(n=>typeof n=="function"?{_zod:{check:n,def:{check:"custom"},onattach:[]}}:n)]}),t.clone=(r,n)=>T(t,r,n),t.brand=()=>t,t.register=(r,n)=>(r.add(t,n),t)}),$r=w("ZodMiniString",(t,e)=>{pt.init(t,e),me.init(t,e)});function N(t){return vr($r,t)}i(N,"string");var _r=w("ZodMiniNumber",(t,e)=>{lr.init(t,e),me.init(t,e)});function H(t){return hr(_r,t)}i(H,"number");var Co=w("ZodMiniObject",(t,e)=>{dr.init(t,e),me.init(t,e)});function X(t,e){let r={type:"object",get shape(){return l.assignProp(this,"shape",{...t}),this.shape},...l.normalizeParams(e)};return new Co(r)}i(X,"object");var Bo=w("ZodMiniOptional",(t,e)=>{mr.init(t,e),me.init(t,e)});function br(t){return new Bo({type:"optional",innerType:t})}i(br,"optional");var Wo=w("ZodMiniNullable",(t,e)=>{pr.init(t,e),me.init(t,e)});function ft(t){return new Wo({type:"nullable",innerType:t})}i(ft,"nullable");function wr(t,e="SHA-256"){let n=new TextEncoder().encode(t);return crypto.subtle.digest(e,n)}i(wr,"hash");async function Ir(t,e,r,n="SHA-256"){let a=new TextEncoder().encode(e),s={name:"HMAC",hash:n},u=await crypto.subtle.importKey("raw",t,s,!1,["verify"]);return crypto.subtle.verify(s,u,r,a)}i(Ir,"verifyHmac");function kr(t){if(t>=48&&t<=57)return t-48;let e=t|32;if(e>=97&&e<=102)return e-97+10;throw new Error(`Invalid char code: ${t} ('${String.fromCodePoint(t)}')`)}i(kr,"getHexNumber");function zr(t){let e=Math.floor(t.length/2);if(e*2!==t.length)throw new Error("value length is not even");let r=new Uint8Array(e),n=0;for(let o=0;o<t.length;o+=2){let a=kr(t.codePointAt(o)),s=kr(t.codePointAt(o+1));r[n++]=a*16+s}return r}i(zr,"parseHexString");var Nr=X({telegramUserId:H(),username:N(),firstName:N(),authDate:H(),photoUrl:br(N()),hash:N()});function Ho(t){return[["auth_date",t.authDate],["first_name",t.firstName],["id",t.telegramUserId],["photo_url",t.photoUrl],["username",t.username]].filter(([,r])=>r!==void 0).map(([r,n])=>`${r}=${n}`).join(`
`)}i(Ho,"createCheckString");async function Sr(t,e){let r=Ho(t),n=zr(t.hash),o=await wr(e);return Ir(o,r,n)}i(Sr,"verifyAuthorizationHash");function Xo(t,e){return new Response(JSON.stringify(t),{status:e,headers:{"Content-Type":"application/json"}})}i(Xo,"jsonResponse");function pe(t,e){return r=>Xo(r??{message:t},e)}i(pe,"helper");var gt=pe("Not Found",404),Z=pe("Unauthorized",401),O$=pe("Internal Server Error",500),M=pe("Bad Request",400),U$=pe("Conflict",409);function Tr(t){let e=new Headers({"Content-Type":"application/json"});return t&&e.set("Allow",t.join(",")),new Response(JSON.stringify({message:"Method Not Allowed"}),{status:405,headers:e})}i(Tr,"methodNotAllowed");function Q(t,e){return t.headers.get("Authorization")===`Bearer ${e.ACCESS_KEY}`}i(Q,"isAuthorizedRequest");function vt(t,e,r){let n="";for(let o=0;o<r;o++)n+=t,o<r-1&&(n+=e);return n}i(vt,"repeatJoin");function Ge(t){return vt("?",",",t)}i(Ge,"qMarks");var Er=Symbol(),ht={};function Ve(t,e){return{[Er]:!1,expression:e,binding:t}}i(Ve,"createModifier");function yt(t){return e=>Ve(e,t)}i(yt,"modifier");function $t(t){return typeof t=="object"&&t!==null&&Er in t}i($t,"isModifier");function Pr(t){return t===ht}i(Pr,"isNoBinding");function Or(t){return $t(t)?t.binding:t}i(Or,"getMaybeModifierValue");var r_=yt("=?"),Ur=yt("!=?"),Rr=yt(">=?");function Je(t){return Ve(t,`IN (${Ge(t.length)})`)}i(Je,"valueIn");function _t(){return Ve(ht,"IS NOT NULL")}i(_t,"notNull");function jr(){return Ve(ht,"IS NULL")}i(jr,"isNull");function Qo(t,e){return $t(e)?`"${t}"${e.expression}`:`"${t}"=?`}i(Qo,"maybeModifierToKeyValue");function qo(t){return Object.entries(t).map(([e,r])=>Qo(e,r)).join(" AND ")}i(qo,"implicitConditionsToExpression");function V(t){return t===void 0?"":Array.isArray(t)?t[0]:qo(t)}i(V,"conditionsToExpression");function J(t){return Array.isArray(t)?t[1]:Object.values(t).flatMap(e=>Or(e)).filter(e=>!Pr(e))}i(J,"getConditionsBinding");function Dr(t,e){return[e.map(r=>`(${V(r)})`).join(t),e.flatMap(r=>J(r))]}i(Dr,"logical");function Ar(...t){return Dr(" AND ",t)}i(Ar,"and");function Zr(...t){return Dr(" OR ",t)}i(Zr,"or");var Yo={async batch(t){let e=[];for(let r of t)e.push(await r.getWithResult());return[e.map(([r])=>r),e.flatMap(([,r])=>r)]}};function Mr(t,e){return{statements:t.statements,mapResult(r){return e(t.mapResult(r),r)},map(r){return Mr(this,r)},async getWithResult(){let[r,n]=await t.getWithResult();return[e(r,n),n]},async get(){let[r,n]=await t.getWithResult();return e(r,n)}}}i(Mr,"mapQuery");function bt(t,e){return{statements:t,map(r){return Mr(this,r)},...e}}i(bt,"createQuery");function ea(t){return bt([t],{mapResult([e]){return e.results},async getWithResult(){let e=await t.all();return[e.results,[e]]},async get(){let{results:e}=await t.all();return e}})}i(ea,"all");function ta(t){return bt([t],{mapResult([e]){return e.results[0]},async getWithResult(){let e=await t.all();return[e.results[0],[e]]},async get(){return t.first()}})}i(ta,"first");function ra(t,e=Yo){function r(){return e.batch(t)}return i(r,"getWithResult"),bt(t.flatMap(({statements:n})=>n),{getWithResult:r,async get(){let[n]=await r();return n},mapResult(n){let o=0;return t.map(s=>{let u=n.slice(o,o+s.statements.length);return o+=s.statements.length,s.mapResult(u)})}})}i(ra,"merge");var z={all:ea,first:ta,merge:ra};function L(t,e,r){return r?`${t} ${e} ${r}`:t}i(L,"withKeyword");function Lr(t){return t.map(e=>`"${e}"`).join(",")}i(Lr,"joinColumns");function Cr(t){return Array.isArray(t)?Lr(t):"*"}i(Cr,"resolveFields");function xt(t,e){return`SELECT ${t} FROM "${e}"`}i(xt,"selectFromTable");function wt(t,e,r,n){let o=Object.keys(r),a=Lr(o);return L(`${t} INTO "${e}" (${a}) VALUES (${Ge(o.length)})`,"RETURNING",n&&`"${n}"`)}i(wt,"buildGeneralInsertQuery");function Br(t,e,r){return L(xt(Cr(r),t),"WHERE",V(e))}i(Br,"buildFindWhereQuery");function Ke(t,e){return L(xt("COUNT(*) as count",t),"WHERE",V(e))}i(Ke,"buildCountWhereQuery");function He(t,e,r,n,o){return L(L(L(xt(Cr(o),t),"WHERE",V(n)),"LIMIT",r),"OFFSET",e>0?e:void 0)}i(He,"buildGetPageQuery");function Wr(t,e,r){let n=Object.entries(r).map(([o,a])=>a!==void 0?`"${o}"=?`:void 0).filter(o=>o!==void 0).join(",");return L(`UPDATE "${t}" SET ${n}`,"WHERE",V(e))}i(Wr,"buildUpdateWhereQuery");function Fr(t,e){return L(`DELETE FROM "${t}"`,"WHERE",V(e))}i(Fr,"buildDeleteWhereQuery");function Xe(t,e){let r=Object.entries(e).map(([n,o])=>`"${n}" ${o}`).join(",");return`CREATE TABLE IF NOT EXISTS "${t}" (${r})`}i(Xe,"buildCreateTableQuery");async function Gr(t,e){let[r]=await fe(t,e);return r}i(Gr,"batchHelper");async function fe(t,e){let r=await t.batch(e.flatMap(({statements:a})=>a)),n=0;return[e.map(a=>{let s=r.slice(n,n+a.statements.length);return n+=a.statements.length,a.mapResult(s)}),r]}i(fe,"batchWithResultsHelper");function g(t){return class{constructor(e){this.client=e,this.queryContext={batch(r){return fe(e,r)}}}async updateWhere(e,r){let{meta:n}=await this.client.prepare(Wr(t,e,r)).bind(...Object.values(r),...J(e)).run();return{changes:n.changes}}selectAllAction(e,r){return z.all(this.client.prepare(e).bind(...r??[]))}async selectAll(e,r){let{results:n}=await this.client.prepare(e).bind(...r??[]).all();return n}selectOneAction(e,r=[]){return z.first(this.client.prepare(e).bind(...r))}async selectOne(e,r=[]){return this.client.prepare(e).bind(...r).first()}insertBaseAction(e,r,n){let o=this.client.prepare(wt(e,t,r,n)).bind(...Object.values(r));return z.first(o).map(a=>{if(!(a===null||n===void 0))return a[n]})}async insertBase(e,r,n){let o=await this.client.prepare(wt(e,t,r,n)).bind(...Object.values(r)).first();if(!(o===null||n===void 0))return o[n]}insert(e,r){return this.insertBase("INSERT",e,r)}insertOrReplace(e,r){return this.insertBase("INSERT OR REPLACE",e,r)}insertOrReplaceAction(e,r){return this.insertBaseAction("INSERT OR REPLACE",e,r)}insertManyBaseAction(e,r,n){return r.map(o=>this.insertBaseAction(e,o,n))}async insertManyBase(e,r,n){let o=await Promise.all(r.map(a=>this.insertBase(e,a,n)));return n!==void 0?o:void 0}async insertMany(e,r){return this.insertManyBase("INSERT",e,r)}async insertOrReplaceMany(e,r){return this.insertManyBase("INSERT OR REPLACE",e,r)}insertOrReplaceManyAction(e,r){return this.insertManyBaseAction("INSERT OR REPLACE",e,r)}prepareFindWhereStatement(e,r){let n=J(e);return this.client.prepare(Br(t,e,r)).bind(...n)}findOneWhereAction(e,r){return z.first(this.prepareFindWhereStatement(e,r))}findOneWhere(e,r){return this.prepareFindWhereStatement(e,r).first()}async findManyWhere(e,r){let{results:n}=await this.prepareFindWhereStatement(e,r).all();return n}findManyWhereAction(e,r){return z.all(this.prepareFindWhereStatement(e,r))}getPageBase(e,r,n={},o){return this.selectAllAction(He(t,e,r,n,o),J(n))}deleteWhere(e){return z.first(this.client.prepare(Fr(t,e)).bind(...J(e))).map((r,[n])=>({changes:n.meta.changes}))}async deleteAll(){await this.client.prepare(`DELETE FROM ${t}`).run()}count(e){let r=this.client.prepare(Ke(t,e)).bind(...e?J(e):[]);return z.first(r).map(n=>n?.count??0)}all(e="*"){return this.findManyWhereAction({},e)}createTable(e){return this.client.exec(Xe(t,e))}getCollection(e){throw new Error("Not implemented")}static descriptor(){throw new Error("Not implemented")}static toString(){return t}}}i(g,"EntityCollection");var ge=class extends g("admin_bot_new_user_messages"){static{i(this,"AdminBotNewUserMessagesCollection")}static descriptor(){return{chatId:"INTEGER NOT NULL",messageId:"INTEGER NOT NULL",newUserId:"INTEGER NOT NULL"}}getMessagesByNewUserId(e){return this.findManyWhereAction({newUserId:e},["chatId","messageId"])}deleteMessagesByNewUserId(e){return this.deleteWhere({newUserId:e})}};function It(t){return{...t,description:JSON.parse(t.description),images:JSON.parse(t.images)}}i(It,"mapRawEvent");var ve=class extends g("events"){static{i(this,"EventCollection")}static descriptor(){return{id:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT",date:"INTEGER NOT NULL",description:"TEXT NOT NULL",status:"INTEGER NOT NULL",title:"TEXT NOT NULL",images:"TEXT NOT NULL"}}update(e,{description:r,images:n,...o}){return this.updateWhere({id:e},{description:r!==void 0?JSON.stringify(r):void 0,images:n!==void 0?JSON.stringify(n):void 0,...o})}insertEvent({description:e,images:r,...n}){return this.insert({description:JSON.stringify(e),images:JSON.stringify(r),...n},"id")}async findById(e){let r=await this.findOneWhere({id:e});return r?It(r):null}async getDescriptionById(e){let r=await this.findOneWhere({id:e},["description"]);return r!==null?JSON.parse(r.description):null}getAllShortEvents(){return this.all(["id","title"]).get()}async getLatestEvents(e){return(await this.selectAll(`SELECT * FROM events ORDER BY date DESC LIMIT ${e}`)).map(n=>It(n))}async getPage(e,r){let[n,o]=await this.client.batch([this.client.prepare(Ke("events")),this.client.prepare(He("events",e*r,r))]);return{total:n.results[0].count,items:o.results.map(a=>It(a))}}};var he=class extends g("forgot_password_entries"){static{i(this,"ForgotPasswordCollection")}static descriptor(){return{token:"TEXT NOT NULL PRIMARY KEY",email:"TEXT NOT NULL",expirationDate:"INTEGER NOT NULL"}}updatePasswordByToken(e,r,n){return z.first(this.client.prepare(`UPDATE users as u
SET passwordHash=?
FROM (SELECT email, token, expirationDate FROM forgot_password_entries) as e
WHERE e.token = ? AND e.expirationDate >= ?`).bind(r,e,n)).map((o,[a])=>({changes:a.meta.changes}))}deleteByToken(e){return this.deleteWhere({token:e})}async tokenExistsAndNotExpired(e,r){return await this.count({token:e,expirationDate:Rr(r)}).get()>0}};var ye=class extends g("gallery_images"){static{i(this,"GalleryImageCollection")}static descriptor(){return{id:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT",date:"INTEGER NOT NULL",eventId:"INTEGER",images:"TEXT NOT NULL",order:"INTEGER NOT NULL"}}update(e,{images:r,...n}){return this.updateWhere({id:e},r?{images:JSON.stringify(r),...n}:n)}async getGalleryImageWithEvent(e){let r=await this.selectOne(`SELECT gallery_images.date as galleryDate, events.id as eventId, events.title as eventTitle 
      FROM gallery_images 
      INNER JOIN events ON events.id=gallery_images.id 
      WHERE gallery_images.id=?`);return r&&{id:e,date:r.galleryDate,event:{id:r.eventId,title:r.eventTitle}}}async getPage(e,r){return(await this.getPageBase(e*r,r,{},["id","images"]).get()).map(({id:o,images:a})=>({id:o,images:JSON.parse(a)}))}async getImageSizes(e){let r=await this.findOneWhere({id:e},["images"]);return r?JSON.parse(r.images):null}};var $e=class extends g("groups"){static{i(this,"GroupCollection")}static descriptor(){return{campusId:"TEXT NOT NULL PRIMARY KEY",name:"TEXT NOT NULL"}}insertOrUpdateAll(e){return this.insertOrReplaceManyAction(e)}findByCampusId(e){return this.findOneWhereAction({campusId:e})}findByIds(e){return this.findManyWhereAction({campusId:Je(e)})}groupExists(e){return this.count({campusId:e}).map(r=>r>0)}};var _e=class extends g("pending_users"){static{i(this,"PendingUserCollection")}static descriptor(){return{token:"TEXT NOT NULL PRIMARY KEY",academicGroup:"TEXT NOT NULL",createdAt:"INTEGER NOT NULL",email:"TEXT NOT NULL",firstName:"TEXT NOT NULL",lastName:"TEXT NOT NULL",parentName:"TEXT",passwordHash:"TEXT NOT NULL",telnum:"TEXT"}}findByToken(e){return this.findOneWhere({token:e})}};var C=class extends g("poll_respondents"){static{i(this,"PollRespondentCollection")}static descriptor(){return{pollId:"INTEGER NOT NULL",date:"INTEGER NOT NULL",answers:"TEXT NOT NULL",userId:"INTEGER NOT NULL"}}};var be=class extends g("polls"){static{i(this,"PollCollection")}static descriptor(){return{id:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT",title:"TEXT NOT NULL",startDate:"INTEGER NOT NULL",endDate:"INTEGER",questions:"TEXT NOT NULL"}}findShortPoll(e){return this.findOneWhere({id:e},["id","title","startDate","endDate"])}findEndDateAndQuestions(e){return this.findOneWhereAction({id:e},["endDate","questions","title"]).map(r=>r===null?null:{id:e,title:r.title,endDate:r.endDate,questions:JSON.parse(r.questions)})}hasUserResponded(e,r){return this.getCollection(C).count({pollId:e,userId:r}).map(n=>n>0)}insertPoll({questions:e,...r}){return this.insert({questions:JSON.stringify(e),...r})}async findPollWithQuestionsAndAnswers(e){let r=this.findOneWhereAction({id:e},["questions"]),n=this.getCollection(C).findManyWhereAction({pollId:e},["date","answers"]),[o,a]=await z.merge([r,n],this.queryContext).get();if(o===null)return null;let{questions:s}=o;return{questions:JSON.parse(s),respondents:a.map(({date:u,answers:c})=>({date:u,answers:JSON.parse(c)}))}}addRespondent(e,r){return this.getCollection(C).insert({pollId:e,answers:JSON.stringify(r.answers),date:r.date,userId:r.userId})}async closePoll(e){return this.updateWhere({id:e,endDate:jr()},{endDate:Date.now()})}async getPage(e,r){let[n,o]=await z.merge([this.count(),this.getPageBase(e*r,r,{},["id","title"])],this.queryContext).get();return{total:n,items:o}}};var q=class extends g("schedule_lessons"){static{i(this,"ScheduleLessonCollection")}static descriptor(){return{groupCampusId:"TEXT NOT NULL",week:"INTEGER NOT NULL",day:"INTEGER NOT NULL",type:"INTEGER NOT NULL",name:"TEXT NOT NULL",place:"TEXT NOT NULL",time:"TEXT NOT NULL",teacher:"TEXT NOT NULL"}}};function na(t,e){let r=[{},{}];for(let{week:n,day:o,...a}of t){let s=r[n-1],u=s[o];u===void 0&&(u={day:o,lessons:[]},s[o]=u),u.lessons.push(e(a))}return[Object.values(r[0]),Object.values(r[1])]}i(na,"splitToWeeks");var xe=class extends g("schedule"){static{i(this,"ScheduleCollection")}static descriptor(){return{groupCampusId:"TEXT NOT NULL PRIMARY KEY",links:"TEXT"}}findByGroupWithTeachers(e){let r=this.selectAllAction(`SELECT week, day, place, teacher, time, type, link, schedule_teachers.link as teacher_link, schedule_lessons.name as lesson_name
      FROM schedule_lessons 
      RIGHT JOIN schedule_teachers ON schedule_lessons.teacher=schedule_teachers.name 
      WHERE groupCampusId=?`,[e]),n=this.findOneWhereAction({groupCampusId:e},["links"]);return z.merge([r,n]).map(([o,a])=>o.length>0?{groupCampusId:e,weeks:na(o,({teacher:s,teacher_link:u,lesson_name:c,...p})=>({...p,name:c,teacher:{name:s,link:u}})),links:a&&a.links?JSON.parse(a.links):null}:null)}upsertWeeks({groupCampusId:e,weeks:r}){let n=this.getCollection(q);return[n.deleteWhere({groupCampusId:e}),...n.insertOrReplaceManyAction(r.map((o,a)=>o.map(({day:s,lessons:u})=>u.map(({teacher:c,...p})=>({groupCampusId:e,week:a+1,day:s,teacher:c.name,...p})))).flat(2))]}updateLinks(e,r){return this.updateWhere({groupCampusId:e},{links:JSON.stringify(r)})}async getLinks(e){let r=await this.findOneWhere({groupCampusId:e},["links"]);return r&&r.links?JSON.parse(r.links):{}}};function ia(t){let e=new Map;for(let r of t.weeks)for(let{lessons:n}of r)for(let{teacher:o}of n)e.set(o.name,o);return[...e.values()]}i(ia,"uniqueTeachers");var we=class extends g("schedule_teachers"){static{i(this,"ScheduleTeacherCollection")}static descriptor(){return{name:"TEXT NOT NULL PRIMARY KEY",link:"TEXT"}}insertFromSchedule(e){return this.insertOrReplaceManyAction(ia(e))}findByName(e){return this.findOneWhere({name:e})}findByNames(e){return this.findManyWhere({name:Je(e)})}};var Ie=class extends g("sessions"){static{i(this,"SessionCollection")}static descriptor(){return{sessionId:"TEXT NOT NULL PRIMARY KEY",userId:"INTEGER NOT NULL"}}async findBySessionId(e){return this.findOneWhere({sessionId:e})}async deleteBySessionId(e){return this.deleteWhere({sessionId:e}).get()}async getUserIdBySessionId(e){return(await this.findOneWhere({sessionId:e},["userId"]))?.userId??0}async getUserBase(e,r){let n=r.map(o=>`users.${o} as ${o}`).join(",");return this.selectOne(`SELECT ${n} FROM sessions INNER JOIN users ON users.id = sessions.userId WHERE sessions.sessionId = ?`,[e])}async getUserWithRole(e){return this.getUserBase(e,["id","role","hasAvatar"])}async getUserWithRoleAndGroup(e){return this.getUserBase(e,["id","role","hasAvatar","academicGroup"])}async sessionExists(e){return await this.count({sessionId:e}).get()>0}async getUserPersonalInfo(e){return this.getUserBase(e,["firstName","lastName","parentName"])}async getUserWithPassword(e){return await this.getUserBase(e,["id","passwordHash"])}};var ke=class extends g("update_times"){static{i(this,"UpdateTimeCollection")}static descriptor(){return{type:"TEXT NOT NULL PRIMARY KEY",time:"INTEGER NOT NULL"}}getByTypeAction(e){return this.findOneWhereAction({type:e}).map(r=>r?.time??0)}async getByType(e){return(await this.findOneWhere({type:e}))?.time??0}setByType(e,r){return this.insertOrReplaceAction({type:e,time:r})}};var ze=class extends g("users"){static{i(this,"UserCollection")}static descriptor(){return{id:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT",academicGroup:"TEXT NOT NULL",email:"TEXT NOT NULL",firstName:"TEXT NOT NULL",lastName:"TEXT NOT NULL",parentName:"TEXT",passwordHash:"TEXT NOT NULL",role:"INTEGER NOT NULL",scheduleBotUserId:"INTEGER",adminBotUserId:"INTEGER",telnum:"TEXT",hasAvatar:"INTEGER NOT NULL"}}async findUserByEmail(e){let r=await this.findOneWhere({email:e});return r&&{...r,hasAvatar:r.hasAvatar===1}}updateScheduleBotUserId(e,r){return this.updateWhere({id:e},{scheduleBotUserId:r})}updateAdminBotUserId(e,r){return this.updateWhere({id:e},{adminBotUserId:r})}findByScheduleBotUserId(e){return this.findOneWhere({scheduleBotUserId:e})}findByAdminBotUserId(e){return this.findOneWhere({adminBotUserId:e})}findAllUsersWithLinkedScheduleBot(){return this.findManyWhere({scheduleBotUserId:_t()},["id","academicGroup","scheduleBotUserId"])}findAllUsersWithLinkedAdminBot(e){return this.findManyWhere(Ar({adminBotUserId:_t()},Zr({role:2},{role:1,academicGroup:e})),["id","academicGroup","adminBotUserId"])}getRoleAndGroupByAdminBotUserId(e){return this.findOneWhereAction({adminBotUserId:e},["academicGroup","role"])}getRoleAndGroupById(e){return this.findOneWhereAction({id:e},["academicGroup","role"])}async findAllNonApprovedUsers(e){return(await this.findManyWhere(e?{academicGroup:e}:{},["id","academicGroup","firstName","lastName","parentName","email","role","hasAvatar"])).map(({hasAvatar:n,...o})=>({...o,hasAvatar:n===1}))}updateRole(e,r){return this.updateWhere({id:e},{role:r})}updateRoleIfNonApprovedUser(e,r){return this.updateWhere({id:e,role:-1},{role:r})}updatePassword(e,r){return this.updateWhere({id:e},{passwordHash:r})}updateHasAvatar(e,r){return this.updateWhere({id:e},{hasAvatar:r?1:0})}updatePersonalInfo(e,{firstName:r,lastName:n,parentName:o}){return this.updateWhere({id:e},{firstName:r,lastName:n,parentName:o})}async getUserAcademicGroup(e){return(await this.findOneWhere({id:e},["academicGroup"]))?.academicGroup??null}async getPage(e,r){return(await this.getPageBase(e*r,r,{role:Ur(2)},["id","firstName","lastName","parentName","academicGroup","email","role","hasAvatar"]).get()).map(({hasAvatar:o,...a})=>({hasAvatar:o===1,...a}))}getPersonalInfo(e){return this.findOneWhere({id:e},["firstName","lastName","parentName"])}async userWithEmailExists(e){return await this.count({email:e}).get()>0}};var Jr=[ze,_e,ve,ye,Ie,xe,q,we,ke,$e,be,C,he,ge],P=class t{constructor(e){this.users=this.collection(ze);this.pendingUsers=this.collection(_e);this.events=this.collection(ve);this.galleryImages=this.collection(ye);this.sessions=this.collection(Ie);this.schedule=this.collection(xe);this.scheduleTeachers=this.collection(we);this.updateTime=this.collection(ke);this.groups=this.collection($e);this.polls=this.collection(be);this.forgotPasswordEntries=this.collection(he);this.adminBotNewUserMessages=this.collection(ge);this.client=e;let r=new Map,n=i(o=>{let a=r.get(o);if(a===void 0)throw new Error("Cannot find collection");return a},"getCollection");for(let o of Jr){let a=new o(e);a.getCollection=n,r.set(o,a)}this.collections=r}static{i(this,"Repository")}static async init(e){let r=[];for(let n of Jr){let o=n.descriptor();r.push([n.toString(),o])}for(let[n,o]of r)await e.prepare(Xe(n,o)).run()}collection(e){return()=>{let r=this.collections.get(e);if(r===void 0)throw new Error("Cannot find collection");return r}}async batch(e){return Gr(this.client,e)}async batchWithResults(e){return fe(this.client,e)}static setDefaultDatabase(e){t.defaultDatabase=e}async deleteAll(){for(let e of this.collections.values())await e.deleteAll()}static openConnection(e){let r=e??t.defaultDatabase;if(r===void 0)throw new Error("No default database");return new t(r)}};var Qe=class{static{i(this,"TelegramBot")}constructor(e){this.apiKey=e}async apiMethod(e,r){let o=await(await fetch(`https://api.telegram.org/bot${this.apiKey}/${e}`,{method:"POST",body:r===void 0?void 0:JSON.stringify(r),headers:{"Content-Type":"application/json"}})).json();if(!o.ok)throw new Error(o.description);return o.result}sendMessage(e,r,n){return this.apiMethod("sendMessage",{chat_id:e,text:r,parse_mode:"Markdown",...n})}deleteMessage(e,r){return this.apiMethod("deleteMessage",{chat_id:e,message_id:r})}setWebhook(e,r){return this.apiMethod("setWebhook",{url:e,secret_token:r})}deleteWebhook(){return this.apiMethod("deleteWebhook")}};async function kt(t,e){try{await Promise.all(e.map(async({chatId:r,messageId:n})=>t.deleteMessage(r,n)))}catch(r){console.error(r)}}i(kt,"deleteMessagesAcrossChats");var qe="approveuser-";function zt(t,e){return`${qe}${t}-${e}`}i(zt,"createApproveUserCallback");function Kr(t){return t.startsWith(qe)}i(Kr,"isApproveUserCallbackByPrefix");function oa(t){return t==="appprove"||t=="disapprove"}i(oa,"isApproveUserAction");function Hr(t){let e=t.indexOf("-",qe.length),r=Number.parseInt(t.slice(qe.length,e)),n=t.slice(e+1);return Number.isNaN(r)||!oa(n)?null:{userId:r,action:n}}i(Hr,"parseApproveUserCallback");var Xr={greeting:`\u0412\u0456\u0442\u0430\u0454\u043C\u043E!

\u0414\u043B\u044F \u0442\u043E\u0433\u043E, \u0449\u043E\u0431 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0442\u0438\u0441\u044F \u0446\u0438\u043C \u0431\u043E\u0442\u043E\u043C \u043F\u043E\u0442\u0440\u0456\u0431\u043D\u043E \u043F\u0440\u0438\u0432'\u044F\u0437\u0430\u0442\u0438 \u0432\u0430\u0448 \u0442\u0435\u043B\u0435\u0433\u0440\u0430\u043C \u0430\u043A\u043A\u0430\u0443\u043D\u0442 \u0434\u043E \u043E\u0431\u043B\u0456\u043A\u043E\u0432\u043E\u0433\u043E \u0437\u0430\u043F\u0438\u0441\u0443 SC FAM

https://sc-fam.org/u/admin-bot`,"already-linked-account":"\u0423 \u0432\u0430\u0441 \u0432\u0436\u0435 \u043F\u0440\u0438\u0432'\u044F\u0437\u0430\u043D\u0438\u0439 \u0430\u043A\u043A\u0430\u0443\u043D\u0442","success-linking":`\u0412\u0438 \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u043F\u0440\u0438\u0432'\u044F\u0437\u0430\u043B\u0438 \u0446\u0435\u0439 \u0442\u0435\u043B\u0435\u0433\u0440\u0430\u043C \u0430\u043A\u043A\u0430\u0443\u043D\u0442 \u0434\u043E \u043E\u0431\u043B\u0456\u043A\u043E\u0432\u043E\u0433\u043E \u0437\u0430\u043F\u0438\u0441\u0443 SC FAM

\u0422\u0435\u043F\u0435\u0440 \u0432\u0438 \u0431\u0443\u0434\u0435\u0442\u0435 \u043E\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u0442\u0438 \u0441\u043F\u043E\u0432\u0456\u0449\u0435\u043D\u043D\u044F \u043F\u0440\u043E \u043D\u043E\u0432\u0438\u0445 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0456\u0432`,"approve-user-text":`\u041D\u043E\u0432\u0438\u0439 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447!

\u0406\u043C'\u044F: {firstName}`,approve:"\u041F\u0456\u0434\u0442\u0432\u0435\u0440\u0438\u0442\u0438",disapprove:"\u0412\u0438\u0434\u0430\u043B\u0438\u0442\u0438 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0430"};function Ne(t){return Xr[t]}i(Ne,"getMessage");var O=class{static{i(this,"BotController")}constructor(e){this.bot=new Qe(e.BOT_KEY)}async handleUpdate(e){console.log(`Received update: ${JSON.stringify(e)}`),e.message!==void 0?await this.handleMessage(e.message):e.callback_query!==void 0&&await this.handleCallbackQuery(e.callback_query)}async handleMessage(e){if(e.text!==void 0&&e.text.startsWith("/start")){let n=await P.openConnection().users().findByAdminBotUserId(e.from.id);await this.bot.sendMessage(e.from.id,Ne(n===null?"greeting":"already-linked-account"))}}async handleAuth(e){await this.bot.sendMessage(e,Ne("success-linking"))}async handleNewUserEvent(e){function r(){let c=[["\u0406\u043C'\u044F",e.firstName],["\u041F\u0440\u0456\u0437\u0432\u0438\u0449\u0435",e.firstName],["\u041F\u043E-\u0431\u0430\u0442\u044C\u043A\u043E\u0432\u0456",e.firstName],["\u0415\u043B\u0435\u043A\u0442\u0440\u043E\u043D\u043D\u0430 \u043F\u043E\u0448\u0442\u0430",e.firstName],["\u0413\u0440\u0443\u043F\u0430",e.academicGroup],["\u0422\u0435\u043B\u0435\u0444\u043E\u043D",e.telnum]],p=`\u041D\u043E\u0432\u0438\u0439 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447!

`;return p+=c.map(([y,f])=>`${y}: ${f}`).join(`
`),p}i(r,"createText");let n=P.openConnection(),o=await n.users().findAllUsersWithLinkedAdminBot(e.academicGroup),a=r(),s={reply_markup:{inline_keyboard:[[{text:Ne("approve"),callback_data:zt(e.id,"approve")},{text:Ne("disapprove"),callback_data:zt(e.id,"disapprove")}]]}},u=await Promise.all(o.map(({adminBotUserId:c})=>this.bot.sendMessage(c,a,s)));await n.adminBotNewUserMessages().insertMany(u.map((c,p)=>({chatId:o[p].id,newUserId:e.id,messageId:c.message_id})))}async handleNewUserApprovedExternally(e){let r=P.openConnection(),[n]=await r.batch([r.adminBotNewUserMessages().getMessagesByNewUserId(e),r.adminBotNewUserMessages().deleteMessagesByNewUserId(e)]);await kt(this.bot,n)}async handleCallbackQuery(e){let{data:r}=e;if(r!==void 0&&Kr(r)){let n=Hr(r);if(n===null){console.error("Invalid callback data");return}let{userId:o,action:a}=n,s=P.openConnection(),u=e.from.id,[c,p,y]=await s.batch([s.users().getRoleAndGroupByAdminBotUserId(u),s.users().getRoleAndGroupById(o),s.adminBotNewUserMessages().getMessagesByNewUserId(o)]);if(c===null){console.error("Callback came from unknown user");return}if(p===null){console.error("Unknown target user");return}if(c.role<1||c.role===1&&c.academicGroup!==p.academicGroup){console.error("Callback came from unauthorized user");return}switch(a){case"approve":{await s.users().updateRole(o,0);break}case"disapprove":{await s.users().deleteWhere({id:o}).get();break}}await kt(this.bot,y),await s.adminBotNewUserMessages().deleteMessagesByNewUserId(o).get()}}};var Ye=class{constructor(e=""){this.rootNode={children:{}};this.get=this.createPathHandler("GET");this.post=this.createPathHandler("POST");this.put=this.createPathHandler("PUT");this.patch=this.createPathHandler("PATCH");this.delete=this.createPathHandler("DELETE");this.prefix=e}static{i(this,"ParamRouter")}createPathHandler(e){return(r,n)=>{this.addPath(r,e,n)}}addPath(e,r,n){let o=e.slice(1).split("/"),a=this.rootNode;for(let u of o){let c=u.startsWith(":"),p=c?u.slice(1):u,y=c?a.paramNode?.value:a.children[p];if(y===void 0){if(c&&a.paramNode!==void 0&&a.paramNode.name!==p)throw new Error("Already have param route");y={children:{}},c?a.paramNode={name:p,value:y}:a.children[p]=y}a=y}let s=a;s.handlers===void 0&&(s.handlers={}),s.handlers[r]=n}handleRequest(e,r){let{pathname:n}=new URL(e.url);if(n.startsWith(this.prefix)){let o={},a=n.slice(this.prefix.length+1).split("/"),s=this.rootNode;for(let u of a){let c=s.children[u];if(c===void 0){let{paramNode:p}=s;if(p!==void 0)c=p.value,o[p.name]=u;else return Promise.resolve(gt())}s=c}if("handlers"in s&&s.handlers){let{handlers:u}=s,c=u[e.method];return c?c(e,{env:r,params:o}):Promise.resolve(Tr(Object.keys(u)))}}return Promise.resolve(gt())}};var E=new Ye;var sa=5*60*1e3;E.post("/auth",async(t,{env:e})=>{if(!Q(t,e))return Z();let r=await t.json(),n=Nr.safeParse(r);if(!n.success)return M();let o=n.data;return Date.now()-o.authDate*1e3>sa?(console.error("Stale payload"),Z()):await Sr(o,e.BOT_KEY)?(await new O(e).handleAuth(o.telegramUserId),new Response):Z()});function Qr(t){return t.headers.get("x-telegram-bot-api-secret-token")}i(Qr,"getApiSecretToken");E.post("/update",async(t,{env:e})=>{if(Qr(t)!==e.BOT_SECRET_TOKEN)return M();let n=new O(e),o=await t.json();return await n.handleUpdate(o),new Response});var qr=X({user:X({id:H(),firstName:N(),lastName:N(),parentName:ft(N()),academicGroup:N(),email:N(),telnum:ft(N())})}),Yr=X({userId:H()});E.post("/events/newUser",async(t,{env:e})=>{if(!Q(t,e))return Z();let r=await t.json(),n=qr.safeParse(r);if(!n.success)return console.error(n.error.message),M();let{user:o}=n.data;return await new O(e).handleNewUserEvent(o),new Response});E.post("/events/newUser/approvedExternally",async(t,{env:e})=>{if(!Q(t,e))return Z();let r=await t.json(),n=Yr.safeParse(r);if(!n.success)return M();let{userId:o}=n.data;return await new O(e).handleNewUserApprovedExternally(o),new Response});var mk={fetch(t,e){return P.setDefaultDatabase(e.DB),E.handleRequest(t,e)}};export{mk as default};
//# sourceMappingURL=index.js.map
